<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>choria design tool</title>
		<link rel="stylesheet" type="text/css" href="css/normalize.min.css">
		<link rel="stylesheet" type="text/css" href="css/handsontable.full.min.css">
		<link rel="stylesheet" type="text/css" href="css/main.css">
		<script src="js/functions.js"></script>
		<script src="js/handsontable.full.min.js"></script>
		<script src="js/jquery-2.1.4.min.js"></script>
		<link rel="icon" type="image/png" href="img/favicon.png">
	</head>
	<body>
		<div class="nav">
			<ul>
				<li><a href="/">Home</a></li>
			</ul>
		</div>
		<div class="nav small">
			<ul id="tables" >
			</ul>
		</div>
		<div class="container">
			<div class="buttons">
				<input type="button" id="add" value="Add Row" />
				<input type="button" id="save" value="Save" />
				<span id="message"></span>
			</div>
			<div id="sheet"></div>
			<div class="buttons">
				<input type="button" id="delete" value="Delete" />
				<input type="textbox" id="delete_id" value="" />
			</div>
		</div>
	</body>
	<script>
		$(document).ajaxError(function() {
			  $("#message").text("check console");
		});

		var hot = null;
		$(document).ready(function() {
			try {
				tablename = querystring["table"][0];
			}
			catch(error) {
				tablename = "item";
			}

			// Load spreadsheet
			var container = document.getElementById('sheet');
			data_url = "/data?table=" + tablename;
			$.getJSON(data_url, function(response) {
				columns = response['columns']
				data = response['data']
				hot = new Handsontable(container, {
					data: data,
					rowHeaders: true,
					colHeaders: columns,
					columnSorting: true,
					cells: function(row, col, prop) {
						var cellProperties = {};
						if(col == 0) {
							cellProperties.readOnly = true;
						}

						return cellProperties;
					},
					afterChange: function(changes, source) {
						update_buttons(0);
					},
					afterSelection: function(r, c, r2, c2) {
						$('#delete_id').val(hot.getDataAtCell(r, 0));
					},
				});

				update_buttons(1);
			});

			// load nav links
			$.getJSON("/tables", function(response) {
				tables = response;
				for(i in tables) {
					table = tables[i];
					li_element = document.createElement("li");
					a_element = document.createElement("a");
					$(a_element).attr("href", "/?table=" + table);
					$(a_element).html(table);
					$(li_element).append(a_element);
					$('#tables').append(li_element);
				}
			});

			// Add handlers
			$('#save').click(function() { save(); });
			$('#add').click(function() { add(); });
			$('#delete').click(function() { remove(); });
		});

		// Change add row/delete button state
		function update_buttons(state) {
			$('#add').prop('disabled', !state);
			$('#delete').prop('disabled', !state);
			$('#delete_id').prop('disabled', !state);
		}

		// Reload data
		function reload() {
			$.getJSON(data_url, function(response) {
				hot.loadData(response['data']);
				update_buttons(1);
			});
		}

		// Save data
		function save() {

			// Send request
			var request = $.ajax({
				type: "POST",
				url: "/save?table=" + tablename,
				data: jQuery.param({'data': hot.getData()}),
				dataType: "html",
				success: function(response, text_status, jqxhr) {
					ajax_success(response, text_status, jqxhr);
					update_buttons(1);
				},
				error: ajax_error,
			});
		}

		// Add new row
		function add() {

			// Send request
			var request = $.ajax({
				type: "POST",
				url: "/add?table=" + tablename,
				data: {},
				dataType: "html",
				success: function(response, text_status, jqxhr) {
					ajax_success(response, text_status, jqxhr);
					reload();
				},
				error: ajax_error,
			});
		}

		// Delete row
		function remove() {
			id = parseInt($('#delete_id').val());
			if(id <= 0 || isNaN(id) || !confirm("Sure ?"))
				return;

			// Send request
			var request = $.ajax({
				type: "POST",
				url: "/remove?table=" + tablename,
				data: {'id': id},
				dataType: "html",
				success: function(response, text_status, jqxhr) {
					ajax_success(response, text_status, jqxhr);
					reload();
				},
				error: ajax_error,
			});
		}

		function ajax_success(response, text_status, jqxhr) {
			result = JSON.parse(response);
			if(text_status == "success") {
				message = result['message'];
				if(result['message'] != undefined)
					$('#message').html(message);
			}
			else
				$('#message').html(text_status);
		}

		function ajax_error(jqxhr, text_status, error) {
			$('#message').html(error);
		}

		// Ctrl+s hotkey
		$(document).keydown(function(event) {
			if(!(String.fromCharCode(event.which).toLowerCase() == 's' && event.ctrlKey) && !(event.which == 19))
				return true;

			event.preventDefault();
			save();

			return false;
		});

	</script>
</html>
