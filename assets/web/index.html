<!doctype html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>choria design tool</title>
		<link rel="stylesheet" type="text/css" href="css/normalize.min.css">
		<link rel="stylesheet" type="text/css" href="css/handsontable.full.min.css">
		<link rel="stylesheet" type="text/css" href="css/main.css">
		<script src="js/functions.js"></script>
		<script src="js/handsontable.full.min.js"></script>
		<script src="js/jquery-2.1.4.min.js"></script>
		<!--<link rel="icon" type="image/png" href="img/favicon.png">-->
	</head>
	<body>
		<div class="nav">
			<ul>
				<li><a href="/">Home</a></li>
			</ul>
		</div>
		<div class="container">
			<div id="buttons">
				<input type="button" id="save" value="Save" />
				<span id="message"></span>
			</div>
			<div id="sheet"></div>
		</div>
	</body>
	<script>
		$(document).ajaxError(function() {
			  $("#message").text("ajax error");
		});

		try {
			tablename = querystring["table"][0];
		}
		catch(error) {
			tablename = "item";
		}

		var container = document.getElementById('sheet');
		var hot = null;
		$.getJSON("/data?table=" + tablename, function(response) {
			columns = response['columns']
			data = response['data']
			hot = new Handsontable(container, {
				data: data,
				rowHeaders: true,
				colHeaders: columns,
				columnSorting: true,
				cells: function(row, col, prop) {
					var cellProperties = {};
					if(col == 0) {
						cellProperties.readOnly = true;
					}

					return cellProperties;
				},
			});
		});

		$('#save').click(function() {
			save();
		});

		// Save data
		function save() {

			// Send request
			var request = $.ajax({
				type: "POST",
				url: "/save?table=" + tablename,
				data: jQuery.param({'data': hot.getData()}),
				success: function (response, text_status, jqxhr) {
					result = JSON.parse(response);
					if(text_status == "success") {
						message = result['message'];
						if(result['message'] != undefined)
							$('#message').html(message);
					}
					else
						$('#message').html(text_status);
				},
				error: function(jqxhr, text_status, error) {
					$('#message').html(error);
				},
				dataType: "html"
			});
		}

		// Ctrl+s hotkey
		$(document).keydown(function(event) {
			if(!(String.fromCharCode(event.which).toLowerCase() == 's' && event.ctrlKey) && !(event.which == 19))
				return true;

			event.preventDefault();
			save();

			return false;
		});

	</script>
</html>
